## Purchase API Guide (Frontend)

This document describes how to create, list, read, update and delete Purchases (Purchase Orders). Responses follow the global format in `API_RESPONSE_README.md`.

Base URL examples:
- Local: `http://localhost:3001`

### Purchase Data Model (current)
- Header fields
  - `id` (uuid) – auto-generated
  - `series` (string) – auto-generated by backend (format: PO-0001, PO-0002, etc.)
  - `supplierId` (uuid)
  - `status` (string; e.g., `NEW`, `APPROVED`)
  - `orderDate` (ISO string)
  - `paymentMethod` (string)
  - `reference` (string)
  - `note` (string)
  - `purchaserId` (uuid)
  - `amount` (number) – mirrors `totalAmount`
  - `totalAmount` (number)
  - `totalQuantity` (number)
  - `createdAt`, `updatedAt` (ISO)

- Line item fields
  - `id` (uuid)
  - `purchaseId` (uuid)
  - `productId` (uuid)
  - `quantity` (number) – quantity in selected UOM
  - `unitPrice` (number) – price per selected UOM
  - `amount` (number) – `quantity * unitPrice`
  - `description` (string)
  - `status` (string; e.g., `NEW`)
  - `uomId` (uuid) – selected UOM
  - `baseUomId` (uuid) – base UOM for the category
  - `unit` (number) – server-computed: `selectedUom.conversionRate / baseUom.conversionRate`
  - `baseQuantity` (number) – server-computed: `quantity * unit` (in base units)

Note: No warehouse/shipping fields yet (by design).

---

### Endpoints

#### Create Purchase
- Method: POST
- URL: `/purchases`
- Body (JSON):
```json
{
  "supplierId": "<uuid>",
  "status": "NEW",
  "orderDate": "2025-11-04T12:00:00.000Z",
  "paymentMethod": "CASH",
  "reference": "RF-123",
  "note": "Urgent",
  "purchaserId": "<uuid>",
  "items": [
    {
      "productId": "<uuid>",
      "quantity": 10,
      "unitPrice": 25.5,
      "description": "Box",
      "uomId": "<uuid>",
      "baseUomId": "<uuid>",
      // Note: unit is optional; server computes it from UOM conversion rates
    }
  ]
}
```
- Response (201):
```json
{
  "success": true,
  "message": "Resource created successfully",
  "data": {
    "id": "<uuid>",
    "series": "PO-0001",
    "supplierId": "<uuid>",
    "status": "NEW",
    "paymentMethod": "CASH",
    "amount": 255,
    "totalAmount": 255,
    "totalQuantity": 10,
    "createdAt": "...",
    "updatedAt": "..."
  }
}
```

Validation errors:
```json
{
  "success": false,
  "message": "Validation failed",
  "errors": { "series": "series should not be empty" }
}
```

#### List Purchases (pagination/search)
- Method: GET
- URL: `/purchases?page=1&limit=20&q=PO-2025`
- Response (200):
```json
{
  "success": true,
  "message": "Items fetched successfully",
  "data": [ { "id": "<uuid>", "series": "PO-2025-0001", "status": "NEW" } ],
  "meta": {
    "totalItems": 57,
    "itemCount": 20,
    "itemsPerPage": 20,
    "totalPages": 3,
    "currentPage": 1,
    "search": "PO-2025"
  }
}
```

#### Get Purchase by ID
- Method: GET
- URL: `/purchases/:id`
- Response (200):
```json
{
  "success": true,
  "message": "Items fetched successfully",
  "data": { "id": "<uuid>", "series": "PO-2025-0001" }
}
```

#### Update Purchase (header fields)
- Method: PATCH
- URL: `/purchases/:id`
- Body (partial):
```json
{
  "status": "APPROVED",
  "paymentMethod": "BANK_TRANSFER",
  "reference": "RF-123"
}
```
- Response (200):
```json
{
  "success": true,
  "message": "Resource updated successfully",
  "data": { "id": "<uuid>", "status": "APPROVED" }
}
```

#### Update Purchase (replace items)
- Method: PATCH
- URL: `/purchases/:id`
- Body (include `items` to replace all lines):
```json
{
  "items": [
    {
      "productId": "<uuid>",
      "quantity": 5,
      "unitPrice": 20,
      "uomId": "<uuid>",
      "baseUomId": "<uuid>",
      "description": "Bag"
      // Note: unit is optional; server computes it from UOM conversion rates
    }
  ]
}
```
- Validation rules (server-enforced):
  - `uomId` must belong to the product's `unitCategoryId`
  - `baseUomId` must belong to the product's `unitCategoryId` AND must be the base unit (`baseUnit = true`)
  - Server computes `unit = selectedUom.conversionRate / baseUom.conversionRate` (ignores client-submitted `unit` for security)
  - Server computes `baseQuantity = quantity * unit`
  - **NEW**: If purchase has GRNs (Goods Receipt Notes):
    - Cannot delete purchase items that have been received in GRNs
    - Cannot reduce quantity below already received quantity
    - Error examples:
```json
{
  "success": false,
  "message": "Validation failed",
  "errors": {
    "items[0].uomId": "UOM not in product unit category",
    "items[0].baseUomId": "Base UOM must be the category base unit"
  }
}
```
- **NEW**: Error when trying to delete item with GRNs:
```json
{
  "success": false,
  "message": "Validation failed",
  "errors": {
    "general": "Cannot delete purchase item <id> (product: <productId>) because it has been received in GRNs"
  }
}
```
- **NEW**: Error when reducing quantity below received:
```json
{
  "success": false,
  "message": "Validation failed",
  "errors": {
    "general": "Cannot reduce quantity for product <productId>. New baseQuantity (<new>) is less than received quantity (<received>)"
  }
}
```

#### Delete Purchase
#### Get Purchase Received Summary
- Method: GET
- URL: `/purchases/:id/received-summary`
- Response (200):
```json
[
  {
    "purchaseItemId": "<uuid>",
    "orderedBaseQuantity": 200,
    "totalReceived": 150,
    "remaining": 50
  }
]
```
Use this to compute and display Ordered / Received / Remaining and to cap GRN inputs client-side.
- Method: DELETE
- URL: `/purchases/:id`
- **NEW**: Cannot delete purchase if it has associated GRNs (Goods Receipt Notes)
- Error response (400):
```json
{
  "success": false,
  "message": "Cannot delete purchase because it has associated GRNs (Goods Receipt Notes). Please delete the GRNs first.",
  "errors": {
    "general": "Cannot delete purchase because it has associated GRNs (Goods Receipt Notes). Please delete the GRNs first."
  }
}
```
- Success response (204 -> standardized success wrapper):
```json
{
  "success": true,
  "message": "Resource deleted successfully",
  "data": {}
}
```

---

### Frontend Notes
- **Series Generation**: The `series` field is optional in requests. If not provided, the backend auto-generates it in the format `PO-0001`, `PO-0002`, etc. (sequential numbering).
- Always rely on `success` and `meta` (for lists) rather than computing totals client-side.
- `orderDate` accepts ISO strings.
- Totals are computed server-side from items on create; PATCH currently updates header only (not items).
- When sending `items` on PATCH, the server replaces all existing items after validation and recomputes totals.
- Ensure line `uomId`/`baseUomId` match the product's unit category; otherwise you'll get per-line validation errors.
- **UOM Conversion**: 
  - The `unit` field in requests is optional. If provided, it is ignored for security/integrity.
  - Server computes `unit = selectedUom.conversionRate / baseUom.conversionRate`
  - Server computes `baseQuantity = quantity * unit` (stored in base units)
  - Responses include both `unit` and `baseQuantity` for each line item
  - Inventory should be stored and managed in base units only

#### **NEW: Purchase Editing Restrictions (When GRNs Exist)**
- **Check for GRNs before editing**: Before allowing purchase item edits, check if the purchase has any GRNs by fetching the purchase details.
- **UI Restrictions**:
  - If purchase has GRNs, show a warning: "This purchase has received items. Editing is restricted."
  - Disable/disable delete button for purchase items that have GRN references
  - Show received vs ordered quantities to help users understand restrictions
  - Prevent quantity reductions below already received amounts
- **Error Handling**:
  - Handle error: `"Cannot delete purchase item <id> (product: <productId>) because it has been received in GRNs"`
  - Handle error: `"Cannot reduce quantity for product <productId>. New baseQuantity (<new>) is less than received quantity (<received>)"`
  - Show user-friendly messages explaining why the operation is blocked

#### **NEW: Purchase Deletion Restrictions**
- **Check for GRNs before deletion**: Always check if purchase has GRNs before showing delete button
- **UI Behavior**:
  - If purchase has GRNs, disable delete button or show warning
  - Display message: "Cannot delete purchase with received items. Delete GRNs first."
- **Error Handling**:
  - Handle error: `"Cannot delete purchase because it has associated GRNs (Goods Receipt Notes). Please delete the GRNs first."`
  - Show user-friendly message with link to view associated GRNs

### Roadmap (optional)
- Receiving (GRN) linkage and stock updates
- Taxes/discounts at line and header level
- Warehouse/location support


