## GRN (Goods Receipt Note) API Guide (Frontend)

This document describes how to create, list, read, update and delete GRNs (Goods Receipt Notes). Responses follow the global format in `API_RESPONSE_README.md`.

Base URL examples:
- Local: `http://localhost:3001`

### GRN Data Model
- Header fields
  - `id` (uuid) – auto-generated
  - `series` (string) – auto-generated by backend (format: GRN-0001, GRN-0002, etc.)
  - `purchaseId` (uuid) – link to Purchase
  - `receivedDate` (ISO string) – defaults to current date
  - `status` (string) – auto-computed: `PENDING`, `PARTIAL`, `COMPLETE`
  - `receivedBy` (uuid) – optional userId
  - `note` (string) – optional
  - `createdAt`, `updatedAt` (ISO)

- Line item fields
  - `id` (uuid)
  - `grnId` (uuid)
  - `purchaseItemId` (uuid) – link to PurchaseItems
  - `quantityReceived` (number) – quantity received in selected UOM
  - `baseQuantityReceived` (number) – server-computed: `quantityReceived * unit` (in base units)
  - `status` (string; e.g., `NEW`)
  - `uomId` (uuid) – UOM used for receiving
  - `baseUomId` (uuid) – base UOM (must match purchase item's baseUomId)
  - `unit` (number) – server-computed: `selectedUom.conversionRate / baseUom.conversionRate`

### Important Notes
- **Inventory Update**: When a GRN is created/updated, product inventory (`Product.quantity`) is automatically updated by adding `baseQuantityReceived`.
- **Status Calculation**: GRN status is auto-computed based on received vs ordered quantities:
  - `PENDING`: No items received yet
  - `PARTIAL`: Some items received but not all
  - `COMPLETE`: All items fully received
- **Quantity Validation**: Total received quantity (across all GRNs for a purchase item) cannot exceed the ordered quantity.
- **Multiple GRNs per Purchase**: You can create multiple GRNs for the same purchase to handle partial receiving.

---

### Endpoints

#### Create GRN
- Method: POST
- URL: `/grns`
- Body (JSON):
```json
{
  "purchaseId": "<uuid>",
  "receivedDate": "2025-11-04T12:00:00.000Z",
  "status": "PENDING",
  "receivedBy": "<uuid>",
  "note": "Received in good condition",
  "items": [
    {
      "purchaseItemId": "<uuid>",
      "quantityReceived": 10,
      "uomId": "<uuid>",
      "baseUomId": "<uuid>",
      "description": "Received 10 boxes"
    }
  ]
}
```
- Response (201):
```json
{
  "success": true,
  "message": "Resource created successfully",
  "data": {
    "id": "<uuid>",
    "series": "GRN-0001",
    "purchaseId": "<uuid>",
    "receivedDate": "2025-11-04T12:00:00.000Z",
    "status": "PARTIAL",
    "receivedBy": "<uuid>",
    "note": "Received in good condition",
    "createdAt": "...",
    "updatedAt": "...",
    "grnItems": [
      {
        "id": "<uuid>",
        "grnId": "<uuid>",
        "purchaseItemId": "<uuid>",
        "quantityReceived": 10,
        "baseQuantityReceived": 100,
        "status": "NEW",
        "uomId": "<uuid>",
        "baseUomId": "<uuid>",
        "unit": 10
      }
    ]
  }
}
```

Validation errors:
```json
{
  "success": false,
  "message": "Validation failed",
  "errors": {
    "purchaseId": "Purchase not found",
    "items[0].purchaseItemId": "Invalid purchaseItemId",
    "items[0].uomId": "UOM not in product unit category",
    "items[0].baseUomId": "Base UOM must match purchase item base UOM",
    "items[0].quantityReceived": "Total received quantity (150) exceeds ordered quantity (100)"
  }
}
```

#### List GRNs (pagination/search)
- Method: GET
- URL: `/grns?page=1&limit=20&q=GRN-2025&purchaseId=<uuid>`
- Query Parameters:
  - `page` (number, default: 1)
  - `limit` (number, default: 20)
  - `q` (string, optional) – search in series and note
  - `purchaseId` (uuid, optional) – filter by purchase
- Response (200):
```json
{
  "success": true,
  "message": "Items fetched successfully",
  "data": [
    {
      "id": "<uuid>",
      "series": "GRN-0001",
      "purchaseId": "<uuid>",
      "status": "PARTIAL",
      "receivedDate": "...",
      "createdAt": "..."
    }
  ],
  "meta": {
    "totalItems": 57,
    "itemCount": 20,
    "itemsPerPage": 20,
    "totalPages": 3,
    "currentPage": 1,
    "search": "GRN-2025"
  }
}
```

#### Get GRN by ID
- Method: GET
- URL: `/grns/:id`
- Response (200):
```json
{
  "success": true,
  "message": "Items fetched successfully",
  "data": {
    "id": "<uuid>",
    "series": "GRN-0001",
    "purchaseId": "<uuid>",
    "status": "PARTIAL",
    "receivedDate": "...",
    "note": "...",
    "grnItems": [
      {
        "id": "<uuid>",
        "purchaseItemId": "<uuid>",
        "quantityReceived": 10,
        "baseQuantityReceived": 100,
        "uomId": "<uuid>",
        "baseUomId": "<uuid>",
        "unit": 10,
        "purchaseItem": {
          "id": "<uuid>",
          "quantity": 20,
          "baseQuantity": 200,
          "productId": "<uuid>"
        }
      }
    ],
    "purchase": {
      "id": "<uuid>",
      "series": "PO-0001",
      "supplierId": "<uuid>"
    }
  }
}
```

#### Update GRN (header fields)
- Method: PATCH
- URL: `/grns/:id`
- Body (partial):
```json
{
  "status": "COMPLETE",
  "receivedBy": "<uuid>",
  "note": "All items received"
}
```
- Response (200):
```json
{
  "success": true,
  "message": "Resource updated successfully",
  "data": {
    "id": "<uuid>",
    "status": "COMPLETE",
    "note": "All items received"
  }
}
```

#### Update GRN (replace items)
- Method: PATCH
- URL: `/grns/:id`
- **NEW**: Cannot edit items if GRN status is `COMPLETE`. Only metadata fields (note, receivedBy, etc.) can be updated.
- Error when trying to edit COMPLETE GRN items (400):
```json
{
  "success": false,
  "message": "Cannot edit items for GRN with status COMPLETE. Only metadata fields (note, receivedBy, etc.) can be updated.",
  "errors": {
    "general": "Cannot edit items for GRN with status COMPLETE. Only metadata fields (note, receivedBy, etc.) can be updated."
  }
}
```
- Body (include `items` to replace all lines):
```json
{
  "items": [
    {
      "purchaseItemId": "<uuid>",
      "quantityReceived": 15,
      "uomId": "<uuid>",
      "baseUomId": "<uuid>",
      "description": "Received 15 boxes"
    }
  ]
}
```
- **Important**: When updating items, the server:
  1. Reverts old inventory changes (subtracts old `baseQuantityReceived`)
  2. Applies new inventory changes (adds new `baseQuantityReceived`)
  3. Updates GRN status based on received vs ordered quantities
- Validation rules (server-enforced):
  - `purchaseItemId` must belong to the GRN's purchase
  - `uomId` must belong to the product's `unitCategoryId`
  - `baseUomId` must belong to the product's `unitCategoryId` AND must be the base unit (`baseUnit = true`)
  - `baseUomId` must match the purchase item's `baseUomId`
  - Total received quantity (across all GRNs) cannot exceed ordered quantity
  - Server computes `unit = selectedUom.conversionRate / baseUom.conversionRate`
  - Server computes `baseQuantityReceived = quantityReceived * unit`
- Errors are per-line, e.g.:
```json
{
  "success": false,
  "message": "Validation failed",
  "errors": {
    "items[0].purchaseItemId": "Purchase item does not belong to purchase",
    "items[0].uomId": "UOM not in product unit category",
    "items[0].baseUomId": "Base UOM must match purchase item base UOM",
    "items[0].quantityReceived": "Total received quantity (250) exceeds ordered quantity (200)"
  }
}
```

#### Delete GRN
- Method: DELETE
- URL: `/grns/:id`
- **NEW**: Cannot delete GRN if status is `COMPLETE`
- Error when trying to delete COMPLETE GRN (400):
```json
{
  "success": false,
  "message": "Cannot delete GRN with status COMPLETE. Completed GRNs cannot be deleted.",
  "errors": {
    "general": "Cannot delete GRN with status COMPLETE. Completed GRNs cannot be deleted."
  }
}
```
- **Important**: Deleting a GRN automatically reverts inventory changes (subtracts `baseQuantityReceived` from product quantities).
- Success response (204 -> standardized success wrapper):
```json
{
  "success": true,
  "message": "Resource deleted successfully",
  "data": {}
}
```

---

### Frontend Notes

#### Series Generation
- The `series` field is optional in requests. If not provided, the backend auto-generates it in the format `GRN-0001`, `GRN-0002`, etc. (sequential numbering).

#### Inventory Management
- **Automatic Updates**: Product inventory is automatically updated when:
  - Creating a GRN: adds `baseQuantityReceived` to `Product.quantity`
  - Updating a GRN: reverts old quantity, then adds new quantity
  - Deleting a GRN: subtracts `baseQuantityReceived` from `Product.quantity`
- Always use `baseQuantityReceived` for inventory calculations (not `quantityReceived`).

#### Status Management
- GRN status is **auto-computed** by the backend based on received vs ordered quantities:
  - Check total received for each purchase item across all GRNs
  - Compare with ordered quantity
  - Set status accordingly
- You can manually set status in update requests, but it may be recalculated.

#### UOM Validation
- **Critical**: `baseUomId` in GRN items **must match** the purchase item's `baseUomId`.
- `uomId` can be different from the purchase item's `uomId` (you can receive in a different UOM), but must be in the same unit category.
- Server computes `unit` and `baseQuantityReceived` from UOM conversion rates.

#### Quantity Validation
- Total received quantity across all GRNs for a purchase item cannot exceed the ordered quantity.
- Example: If purchase item has `baseQuantity = 200`:
  - First GRN receives `baseQuantityReceived = 100` ✅
  - Second GRN receives `baseQuantityReceived = 100` ✅
  - Third GRN tries to receive `baseQuantityReceived = 50` ❌ (exceeds ordered: 250 > 200)

#### Multiple GRNs per Purchase
- You can create multiple GRNs for the same purchase to handle partial receiving.
- Each GRN can receive different items or the same items with different quantities.
- Backend tracks total received across all GRNs to prevent over-receiving.

#### Best Practices
1. **Always fetch purchase details** before creating a GRN to show available items and quantities.
2. **Show received vs ordered** quantities to users so they know how much is left to receive.
3. **Validate client-side** that `baseUomId` matches the purchase item's `baseUomId`.
4. **Handle partial receiving** by creating multiple GRNs or updating existing ones.
5. **Refresh product inventory** after GRN operations to show updated stock levels.
6. **NEW: Check GRN status before editing/deleting**:
   - If `status === 'COMPLETE'`: Disable item editing and delete button
   - Show message: "Completed GRNs cannot be edited or deleted"
   - Allow only metadata updates (note, receivedBy) for COMPLETE GRNs
7. **NEW: Handle status-based errors gracefully**:
   - Show user-friendly messages when editing/deleting COMPLETE GRNs is blocked
   - Provide clear explanation of why the operation is restricted

---

### Example Workflow

1. **Create Purchase Order** (PO-0001):
   - Order 100 units of Product A (baseQuantity = 100)

2. **Create First GRN** (GRN-0001):
   - Receive 50 units of Product A
   - Status: PARTIAL
   - Product inventory: +50

3. **Create Second GRN** (GRN-0002):
   - Receive remaining 50 units of Product A
   - Status: COMPLETE (all items fully received)
   - Product inventory: +50 (total now +100)

4. **Update GRN** (GRN-0001):
   - Change received quantity from 50 to 60
   - Inventory: -50 (revert) + 60 (apply) = +10 net change
   - Status may change based on totals

5. **Delete GRN** (GRN-0002):
   - Inventory: -50 (revert)
   - GRN-0001 still shows PARTIAL status

